tables:
  - name: purchase
    sql: {{ load_sql('purchase') }}
    description: >
      This table captures customer purchase behavior and aggregated
      transaction metrics. It serves as the primary fact table for
      evaluating product demand consistency, deal dependency,
      channel concentration, and demand stability across the product portfolio.
    public: true

    joins:
      - name: product
        relationship: many_to_one
        sql: "{TABLE.p_customer_id} = {product.product_customer_id}"

      - name: customer
        relationship: many_to_one
        sql: "{TABLE.p_customer_id} = {customer.customer_id}"

    dimensions:
      - name: p_customer_id
        type: number
        column: p_customer_id
        description: "Unique identifier for the customer."
        primary_key: true
        public: true

      - name: purchase_date
        type: time
        column: purchase_date
        description: "Date of the customer’s most recent purchase."

      - name: recency_in_days
        type: number
        column: recency_in_days
        description: "Days since the customer’s last purchase."

      - name: purchases
        type: number
        column: purchases
        description: "Total number of purchases made by the customer."

      - name: spend
        type: number
        column: spend
        description: "Total monetary spend across all purchases."

      - name: deal_purchases
        type: number
        column: numdealspurchases
        description: "Number of purchases made using promotions or deals."

      - name: numwebpurchases
        type: number
        column: numwebpurchases
        description: "Purchases made via web channel."

      - name: numstorepurchases
        type: number
        column: numstorepurchases
        description: "Purchases made via physical store."

      - name: numcatalogpurchases
        type: number
        column: numcatalogpurchases
        description: "Purchases made via catalog channel."

      - name: primary_purchase_channel
        type: string
        sql: >
          CASE
            WHEN {numwebpurchases} >= {numstorepurchases}
             AND {numwebpurchases} >= {numcatalogpurchases} THEN 'Web'
            WHEN {numstorepurchases} >= {numwebpurchases}
             AND {numstorepurchases} >= {numcatalogpurchases} THEN 'Store'
            ELSE 'Catalog'
          END
        description: "Dominant purchase channel for the customer."

      - name: country
        type: string
        sql: "{customer.country}"
        description: "Country of the customer."

    measures:
      - name: total_spend
        sql: "{spend}"
        type: sum
        description: "Total revenue generated from purchases."

      - name: total_purchases
        sql: "{purchases}"
        type: sum
        description: "Total number of purchases."

      - name: average_order_value
        sql: "SUM({spend}) / NULLIF(SUM({purchases}), 0)"
        type: number
        description: "Average spend per purchase."

      - name: deal_dependency_ratio
        sql: "SUM({deal_purchases}) / NULLIF(SUM({purchases}), 0)"
        type: number
        description: >
          Proportion of purchases driven by promotions,
          used to assess discount dependency.

      - name: web_channel_share
        sql: "SUM({numwebpurchases}) / NULLIF(SUM({purchases}), 0)"
        type: number
        description: "Share of purchases coming from the web channel."

      - name: store_channel_share
        sql: "SUM({numstorepurchases}) / NULLIF(SUM({purchases}), 0)"
        type: number
        description: "Share of purchases coming from physical stores."

      - name: catalog_channel_share
        sql: "SUM({numcatalogpurchases}) / NULLIF(SUM({purchases}), 0)"
        type: number
        description: "Share of purchases coming from the catalog channel."


      - name: demand_consistency_score
        sql: >
          CASE
            WHEN AVG({recency_in_days}) < 30 THEN 1
            WHEN AVG({recency_in_days}) BETWEEN 30 AND 90 THEN 0.6
            ELSE 0.3
          END
        type: number
        description: >
          Rule-based indicator measuring consistency of purchasing behavior,
          used as a proxy for demand stability.
